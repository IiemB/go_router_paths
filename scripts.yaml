test: sip test --bail --recursive --concurrent --test-randomize-ordering-seed random

prep:
  - flutter clean
  - dart pub upgrade
  - dart analyze lib test
  - dart format lib test
  - dart pub global run import_sorter:main --no-comments

pub:
    get: sip pub get --recursive --no-version-check --precompile
    upgrade:
        - sip pub upgrade --recursive --no-version-check --major-versions

publish:
  (bail):
  (command):
    - '{$pub:get}'
    - '{$test}'
    - dart pub publish
    - "{$publish:commit}"
    - "{$publish:tag}"
    - "{$publish:_push}"
  commit: |
    # get version from changelog
    version=$(grep -m 1 "# " CHANGELOG.md | awk '{print $2}')

    echo "Committing version $version"
    git add .
    git commit -m "v$version"
  tag: |
    # get version from changelog
    version=$(grep -m 1 "# " CHANGELOG.md | awk '{print $2}')

    echo "Tagging version $version"
    git tag -a "v$version" -m "v$version"
  _push: |
    echo "Pushing to origin"
    git push
    git push --tags